<!doctype html>
<html>
<head>
<title>Example Fabricjs2</title>

<meta charset="utf-8" />
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style type="text/css">
/* ------------------------------------------------------------------------------------------------------------- RESET */

html, body, div, form, p,
code, pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; }

/* ------------------------------------------------------------------------------------------------------------- TEMPLATE */

body { font: 14px/1.333 sans-serif; color: #444; background: #eee; }

a { color: #980905; }
a:hover, a:focus, a:active { text-decoration: none; }

h1 { margin: 0 0 0.5em; font-size: 36px; }
h2 { margin: 0 0 0.75em; font-size: 21px; }
h3 { margin: 0 0 0.333em; font-size: 16px; font-weight: normal; }
p { margin: 0 0 1.333em; }
em { font-style: italic; }
table { border-collapse: separate; border-spacing: 0; margin: 0; vertical-align: middle; }
th { font-weight: bold; }
th, td { padding: 5px 25px 5px 5px; text-align: left; vertical-align: middle; }
pre, code { font-family: monospace, sans-serif; font-size: 1em; color:#080; }

/* ------------------------------------------------------------------------------------------------------------- TEMPLATE */

main { position:relative; overflow:hidden; width: 600px; padding: 40px 60px; border: 1px solid #ccc; margin: 40px auto 20px; background: #fff; -webkit-box-shadow: 0 0 15px rgba(0,0,0,0.1); -moz-box-shadow: 0 0 15px rgba(0,0,0,0.1); box-shadow: 0 0 15px rgba(0,0,0,0.1); }

main pre,
main .prettyprint { padding: 0; border: 0; margin: 0 0 20px; font-size: 13px; background: #fff; }

.ribbon { position: absolute; top: -1px; right: -1px; opacity: 0.9; }
.ribbon:hover, .ribbon:focus, .ribbon:active { opacity: 1; }
.ribbon img { display: block; border: 0; }

.header { padding-right:80px; }

.section { margin: 40px 0 20px; }

.example { padding: 20px; border: 1px solid #ccc; margin: 10px -20px 20px; }

.footer { margin: 20px 0 50px; font-size: 11px; color: #666; text-align: center; }
.footer a { color: #666; }
label {
display: block;
}
input,
label {
margin: 0.4rem 0;
}
input[type="text"] {
padding: 10px;
max-width: 100%;
line-height: 1.5;
border-radius: 5px;
border: 1px solid #ccc;
box-shadow: 1px 1px 1px #999;
}
input[type="file"] {
display: none;
}  
button[onclick*="()"] {
cursor: pointer;
}
button {
padding: 0.5rem 1rem;
border: 1px solid #d0d7de;
border-radius: 0.25rem;
background-color: #f6f8fa;
box-shadow: 0 1px 0 rgba(27, 31, 36, 0.1);
}
button:hover {
background-color: #d8dee4;
}
</style>    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.6.5/fabric.min.js"></script>
<script src="https://jiinbe.github.io/fabricjs/js/FileSaver.js"></script>
<script src="https://jiinbe.github.io/fabricjs/js/canvas-toBlob.js"></script>
</head>

<body>
<main>
<h1>Example Fabricjs2</h1>
<p><canvas id="c" width="300" height="300"></canvas></p>
<p><input type="file" id="imgLoader" accept="image/*"></p>
<label>Brightness:
<input type="range" id="brightness-value" value="0" min="-255" max="255">
</label>
<label>Scale:
<input type="range" id="scale-value" value="100" min="50" max="200">
</label>
<input type="text" id="textInput" placeholder="write something"/>
<p>
<button class="btn" onclick="selectFile()">PILIH FILE</button>
<button id="save-btn">SAVE IMAGE</button>
</p>
</main>
<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.6.5/fabric.min.js"></script>
-->
<script>
var canvas = new fabric.Canvas('c', { isDrawingMode: false, preserveObjectStacking: true });
canvas.selection = false;
canvas.backgroundColor = 'rgba(27, 31, 36, 0.1)';
  
var textX = canvas.width / 2;
var textY = 100;
// var filters = ['grayscale', 'invert', 'remove-white', 'sepia', 'sepia2', 'brightness', 'contrast', 'saturate', 'noise', 'gradient-transparency', 'pixelate', 'blur', 'sharpen', 'emboss', 'tint', 'multiply', 'blend'];
var filters = [];

var origW;
var origH;
var wH;
var hW;

var text = new fabric.Text('', { 
fontFamily: 'Sans-serif',
fill: '#fff',
textAlign: 'center',
originX: 'center',
left: textX, 
top: textY
});

canvas.add(text);

fabric.Image.fromURL('mask.png', function(img) {
  
img.selectable = false;
img.evented = false;
  
canvas.add(img);
 
},{ crossorigin: 'Anonymous' });

function updateCanvasText(txt){
// console.log('text');
text.set({ text: txt });
canvas.bringToFront(text);
canvas.renderAll();
}

function uploadImage(e){
  
var reader = new FileReader();
reader.onload = function (event) {

var imgObj = new Image();
imgObj.src = event.target.result;
imgObj.onload = function () {
var image = new fabric.Image(imgObj);
      
image.filters.push(new fabric.Image.filters.Brightness({ brightness: 0 }));
image.applyFilters(canvas.renderAll.bind(canvas));
      
console.log("canvas = ",canvas);
canvas.add(image);
canvas.sendToBack(image);
canvas.setActiveObject(image);

canvas.item(0).hasControls = canvas.item(0).hasBorders = false;

origW = image.width;
origH = image.height;
wH = origW/origH;
hW = origH/origW;
      
image.width = canvas.width;
image.height = canvas.width *hW ;
      
image.originX = "center";
image.originY = "center";
image.left = canvas.width / 2;
image.top = canvas.height / 2;
// console.log("image b = ",image);
// console.log("image width = ",image.width);
// console.log("image height = ",image.height);

}

}
reader.readAsDataURL(e.target.files[0]);
}


function scaleImage(perc) {
var obj = canvas.getActiveObject();

var newW = canvas.width * perc;
  
obj.width = newW;
obj.height = newW *hW;
  
canvas.renderAll();
  
}

function applyFilterValue(index, prop, value) {
var obj = canvas.getActiveObject();
  
if (obj.filters[index]) {
obj.filters[index][prop] = value;
obj.applyFilters(canvas.renderAll.bind(canvas));
}
}

$('#imgLoader').on('change', function(e){
  
uploadImage(e);
});

$('#textInput').on('keyup', function(e){
    
updateCanvasText($(this).val());
});

// $("#save-btn").on('click', function(){ 
// window.open(canvas.toDataURL());
// });

$("#save-btn").click(function(){
$("#c").get(0).toBlob(function(blob){
saveAs(blob, "myIMG.png");
});
});		

function selectFile() {
document.getElementById("imgLoader").click();
}

canvas.on({
'object:moving': function(e) {
e.target.opacity = 0.5;
},
'object:modified': function(e) {
e.target.opacity = 1;
}
});
  
$('#brightness-value').on('change', function(e){
// console.log("index, prop, value = ", 5, 'brightness', parseInt(this.value, 10))
applyFilterValue(0, 'brightness', parseInt(this.value, 10));
});

$('#scale-value').on('change', function(){
  
// console.log("scale val = ", parseInt(this.value)/100);
var perc = parseInt(this.value)/100;
scaleImage(perc);
});
</script>
</body>
</html>
